<div x-data="{query: ''}" class="w-full">
  <button x-on:click="console.log(query)">Console</button>
  <div class="w-full justify-center">
    <div class="flex gap-x-3 max-w-3xl">
      <!-- prettier-ignore -->
      {{ template "combobox" (dict "ItemPath" "/static/depts.json" "QueryName" "query" "Placeholder" "系所") }}
      <input class="input" placeholder="教師名" />
      <input class="input" placeholder="課名" />
    </div>
    <div x-data="dragDropFiles()" class="w-full max-w-3x1 mt-4 p-8 bg-white shadow-lg rounded-lg">
      <h2 class="text-2xl font-bold text-center mb-4">Upload Your File</h2>

      <div x-bind:class="{'bg-blue-100 border-blue-400': isDragging, 'bg-gray-100 border-gray-300': !isDragging}"
        class="border-2 border-dashed rounded-lg p-6 text-center relative" @dragover.prevent="isDragging = true"
        @dragleave="isDragging = false" @drop.prevent="handleDrop($event)">
        <p class="text-gray-400" x-show="!files.length">
          Drag & Drop files here or click to select
        </p>
        <ul class="gap-y-2">
          <template x-for="(file, index) in files" :key="file.name">
            <li class="flex gap-x-2 text-sm font-medium">
              <button @click="removeFile(index)" class="text-red-400">
                &#10005;
              </button>
              <button @click="await uploadFiles(index)" class="text-green-400">
                &#10003;
              </button>
              <span x-text="file.name"></span>
            </li>
          </template>
        </ul>
        <button @click="uploadFiles(-1)"
          class="absolute bottom-2 right-2 bg-blue-500 text-white px-3 py-1 rounded-md shadow hover:bg-blue-600">
          Upload
        </button>
      </div>

      <input type="file" class="hidden" @change="handleFiles($event)" multiple x-ref="fileInput" />

      <button @click="files.length ? await uploadFiles(-1) : $refs.fileInput.click()"
        class="w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md"
        x-text="files.length ? (isUploading ? 'Uploading...' : 'Upload Files') : 'Select Files'"></button>

      <ul class="gap-y-2">
        <template x-for="(r, i) in results" :key="i">
          <li class="flex gap-x-2 items-center" x-data="{ tooltip: r.url }">
            <span x-text="r.name"></span>
            <button
              @click="navigator.clipboard.writeText(r.url); tooltip = 'Copied!'; setTimeout(() => tooltip = r.url, 1000)"
              class="relative group flex items-center">
              <svg-link class="w-4 h-4"></svg-link>
              <div x-text="tooltip"
                class="absolute bottom-full mb-2 hidden group-hover:block w-max bg-gray-800 text-white text-xs rounded py-1 px-2 shadow-lg">
              </div>
            </button>
          </li>
        </template>
      </ul>
    </div>

    <script>
      function dragDropFiles() {
        return {
          isDragging: false,
          isUploading: false,
          files: [],
          results: [],
          handleDrop(event) {
            this.isDragging = false
            this.files = [...event.dataTransfer.files]
          },
          handleFiles(event) {
            this.files = [...event.target.files]
          },
          removeFile(index) {
            this.files.splice(index, 1)
          },
          uploadFiles(index) {
            const formData = new FormData();

            if (index === -1) {
              // Upload all files
              const filesCopy = [...this.files];
              for (const file of filesCopy) {
                if (file) {
                  formData.append("file", file);
                  console.log(`File Name: ${file.name}, Size: ${file.size} bytes`);
                }
              }
              this.files = []; // Clear files list after upload
            } else {
              // Upload a single file
              const file = this.files[index];
              if (file) {
                formData.append("file", file);
                console.log(`File Name: ${file.name}, Size: ${file.size} bytes`);
                this.removeFile(index);
              }
            }
          },
        }
      }
    </script>

    <script>
      class SvgLink extends HTMLElement {
        constructor() {
          super()
          const markup = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>`
          this.innerHTML = markup
        }
      }
      customElements.define('svg-link', SvgLink)
    </script>

  </div>

</div>