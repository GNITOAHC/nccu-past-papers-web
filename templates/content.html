{{ if .HasReadme }}
<div class="border-foreground border rounded-md p-4 mb-2">
  <p class="markdown">{{ .Readme }}</p>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    window.onload = () => {
      const readme = document.querySelector(".markdown");
      readme.innerHTML = marked.parse(readme.innerHTML);
    };
  </script>
</div>
{{ end }}

<div>
  <input id="search-input" type="text" placeholder="Enter keyword..." />
  <button id="search-button">Search</button>
</div>
<div id="results"></div>

<script>
  // GitHub API Basic Settings
  const GITHUB_API_URL = "https://api.github.com";
  const REPO_OWNER = "GNITOAHC"; // GitHub User Name
  const REPO_NAME = "nccu-past-papers"; // Repo
  const BRANCH = "main"; // Branch
  const TOKEN = "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"; // GitHub Token

  document.getElementById("search-button").addEventListener("click", () => {
    const keyword = document.getElementById("search-input").value.trim();
    if (!keyword) {
      alert("Please enter a keyword.");
      return;
    }
    searchGitHub(keyword);
  });

  // Search GitHub API
  async function searchGitHub(keyword) {
    const treeApiUrl = `${GITHUB_API_URL}/repos/${REPO_OWNER}/${REPO_NAME}/git/trees/${BRANCH}?recursive=1`;

    try {
      // Send API Request
      const response = await fetch(treeApiUrl, {
        headers: {
          Authorization: `token ${TOKEN}`,
        },
      });

      if (!response.ok) {
        throw new Error(`GitHub API Error: ${response.status}`);
      }

      // Parse API Response
      const data = await response.json();

      // Search for matching files and directories
      const results = data.tree.filter((item) =>
        item.path.toLowerCase().includes(keyword.toLowerCase())
      );

      // Display Results
      displayResults(results);
    } catch (error) {
      console.error("Search failed:", error);
      document.getElementById("results").innerHTML =
        "<p>Search failed, please try again later.</p>";
    }
  }


  // Display Results
  function displayResults(results) {
    const resultsContainer = document.getElementById("results");
    if (results.length === 0) {
      resultsContainer.innerHTML = "<p>No matching results.</p>";
      return;
    }

    // HTML Structure
    resultsContainer.innerHTML = results
      .map((item) => {
        const icon = item.type === "tree" ? "Folder: " : "File: ";
        return `
          <div>
            ${icon} <a href="https://github.com/${REPO_OWNER}/${REPO_NAME}/blob/${BRANCH}/${item.path}" target="_blank">${item.path}</a>
          </div>
        `;
      })
      .join("");
  }
</script>

<div class="my-4">
  <!-- prettier-ignore -->
  {{ $path := .Path }} {{ $parts := split .Path "/" }}

  <!-- Initialize empty arrays for Names and Links -->
  <!-- prettier-ignore -->
  {{ $names := slice }} {{ $links := slice }}

  <!-- Create links and names from the path -->
  <!-- prettier-ignore -->
  {{ $currentLink := "/" }}

  {{ range $idx, $part := $parts }}
  {{  if ne $part "" }}
  {{    $currentLink = print $currentLink $part "/" }}
  {{      if $currentLink | eq "/content/" }}
  {{        $names = append $names "HOME" }}
  {{      else }}
  {{        $names = append $names $part }}
  {{      end }}
  {{    $links = append $links $currentLink }}
  {{  end }}
  {{ end }}

  {{ template "breadcrumb" (dict "Names" $names "Links" $links) }}
</div>

<!-- -->

<ul
  class="border divide-y divide-border border-border rounded-lg first-of-type:rounded-t-lg mb-4"
>
  <!-- prettier-ignore -->
  {{ range .Items }}
  {{  if .IsTree }}
  <li class="w-full px-4 py-2">
    <a href="{{ .Link }}">{{ .Name }}</a>
  </li>
  <!-- prettier-ignore -->
  {{  else }}
  {{    $btnc := "w-full px-4 py-2" }}
  {{    template "dropdown" (dict "Menu" (dict "Chat" .Link "Download" .Download) "IsLink" true "Title" .Name "TitleId" .Name "ButtonClass" $btnc) }}
  {{ end }} {{ end }}
</ul>

<form id="upload-form" class="h-20" enctype="multipart/form-data">
  <input type="text" name="name" placeholder="Name" />
  <input type="file" name="file" placeholder="File Input" />
  <button type="submit">Add</button>
</form>
{{ template "upload-script" }} {{ template "upload-modal" }}
<!-- -->


{{ define "upload-script" }}
<script>
  const uploadForm = document.getElementById("upload-form");
  uploadForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const uploadM = new bootstrap.Modal(
      document.getElementById("upload-modal")
    );
    uploadM.show();
    document.getElementById("upload-modal-body").innerHTML = "Loading...";
    const formData = new FormData(uploadForm);
    const res = await fetch(window.location.href, {
      method: "POST",
      body: formData,
    });
    const message = await res.text();
    document.getElementById("upload-modal-body").innerHTML = message;
  });
</script>
{{ end }}

<!-- -->

{{ define "upload-modal" }}
<div class="modal fade" id="upload-modal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered" id="upload-modal-dialog">
    <div class="modal-content">
      <div class="modal-body" id="upload-modal-body"></div>
    </div>
  </div>
</div>
{{ end }}